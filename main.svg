<svg xmlns="http://www.w3.org/2000/svg" class="chart" height="210" width="610" viewBox="0 0 610 210" preserveAspectRatio="none">
<script type="text/javascript" charset="utf-8">
var stream = new EventSource('http://' + document.domain + ':' + location.port + "/stream")
xmlns = "http://www.w3.org/2000/svg";
var old_x = 0;
var old_y = 0;
var l_y = [0,0,0,0,0,0,0,0,0,0];
var scaleY = 1.0;
var tr_x = 0;
var init_max_y = 1.0;
var max_y = 0;
// var height = parseInt(document.firstChild.getAttribute("height"));
// var width = parseInt(document.firstChild.getAttribute("width"));

var height = 150;
var width = 500;
var tr_y = 150; // as height
var trdn = 0;
function T(time_half) {
    document.getElementById("trel").setAttribute("transform", "translate("+tr_x+","+tr_y+") scale(1,"+(-scaleY)+")");
    document.getElementById("timeMid").innerHTML=parseInt(time_half)+"s";
}

stream.onmessage = function (e) {
    tr = document.getElementById("trel");
    var all_data = e.data.split(",").slice(0, 9);
    var el = document.createElementNS(xmlns,"g");
    var x = old_x + width / 50;
    for(i=0; all_data.length>i;i++) {
        var pt = gen_pt(i, all_data[i], x);
        el.appendChild(pt);
    }
    var seconds = new Date().getTime() / 1000;
    el.seconds = seconds;
    el.xval = x;
    old_x = x;
    tr.appendChild(el);
    if(x > 500) {
        tr_x = -(x-500); 
        tr.removeChild(tr.childNodes[0]);
    }
    
    time_half = parseFloat(seconds - tr.childNodes[0].seconds) / parseFloat(x - tr.childNodes[0].xval) * parseFloat(500) / 2;
    T(time_half);
}

function gen_pt(i, ydata, x) {
    var y_data = parseFloat(ydata); // TODO: parse many points 4,5,2;7,6,5
    var txt = ydata.replace(RegExp("[\\d.,]+"),"");
    if(txt.length) {
        document.getElementById("msg").innerHTML=txt;
    }
    if(0 > trdn) {
        max_y_c = max_y / 2;
    } else {
        max_y_c = max_y;
    }
    
    if(Math.abs(y_data) > max_y_c) {
        var dig=Math.abs(y_data);
        max_y = (Math.floor(dig/Math.pow(10,Math.floor(Math.log10(dig))))+1)*Math.pow(10,Math.floor(Math.log10(dig))); // TODO: choose max_y as factor of 10, 2, etc.?
        if(0 > trdn) max_y*=2
    }
    if(init_max_y == false) {
        init_max_y = max_y;
    }
    scaleY = init_max_y / max_y;
    mid_val = max_y/2;
    mid_val_ex="";
    if(mid_val >= 1e3) {
        mid_val /= 1e3;
        mid_val_ex="k";
    }
    if(mid_val >= 1e6) {
        mid_val /= 1e6;
        mid_val_ex="M";
    }
    if(mid_val >= 1e9) {
        mid_val /= 1e9;
        mid_val_ex="G";
    }
    if(mid_val > 1) mid_val = Math.round(mid_val * 100) / 100;
    if(mid_val > 0) mid_val = Math.round(mid_val * 1000) / 1000;
    document.getElementById("valueMid").innerHTML=mid_val+mid_val_ex; 
    //document.getElementById("cur_val"+i).innerHTML=Math.round(y_data * 1000) / 1000;
    var y = parseInt(y_data / init_max_y * height);
    if(0 > y) if (trdn == 0) {
        trdn = -68+20;
        document.getElementById("shift").setAttribute("transform", "translate(55,"+trdn+")");
    }
    var pt = old_x+","+l_y[i]+" "+x+","+y;
    //console.log("adding point " + pt);
    var el = document.createElementNS(xmlns,"polyline");
    el.setAttributeNS(null, "points", pt);
    el.setAttributeNS(null, "class", "src"+i);
    l_y[i] = y;
    return el;
}

document.onload = function() {
    
}
// TODO: onload set the axis, tr
</script>
<style>
.chart {
  background: white;
  /*width: 500px;
  height: 100px;*/
  /*border-left: 1px dotted #555;
  border-bottom: 1px dotted #555;*/
  /*padding: 25px 55px 25px 55px;*/
}


.axis {
stroke: #000000;
stroke-width: 1px;
}

.liner {
stroke: #000000;
stroke-width: 1px;
stroke-dasharray: 1,5;
}


body {
  /* background: #ccc; */
  padding: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

polyline {
    fill: none;
    stroke-width: 2;
    vector-effect: non-scaling-stroke;
}

.data {
    stroke: #0074d9;
}

body, html {
  height: 100%;
}

.src0 {
    stroke: #5DA5DA; /* (blue) */
}
.src1 {
    stroke: #F15854; /* (red) */
}
.src2 {
    stroke: #DECF3F; /* (yellow) */
}
.src3 {
    stroke: #B276B2; /* (purple) */
}
.src4 {
    stroke: #B2912F; /* (brown) */
}
.src5 {
    stroke: #F17CB0; /* (pink) */
}
.src6 {
    stroke: #60BD68; /* (green) */
}
.src7 {
    stroke: #FAA43A; /* (orange) */
}
.src8 {
    stroke: #4D4D4D; /* (gray) */
}

.tsrc0 {
    fill: #5DA5DA; /* (blue) */
}
.tsrc1 {
    fill: #F15854; /* (red) */
}
.tsrc2 {
    fill: #DECF3F; /* (yellow) */
}
.tsrc3 {
    fill: #B276B2; /* (purple) */
}
.tsrc4 {
    fill: #B2912F; /* (brown) */
}
.tsrc5 {
    fill: #F17CB0; /* (pink) */
}
.tsrc6 {
    fill: #60BD68; /* (green) */
}
.tsrc7 {
    fill: #FAA43A; /* (orange) */
}
.tsrc8 {
    fill: #4D4D4D; /* (gray) */
}

</style>

<text x="505" y="25" text-anchor="start" id="cur_val0" style="font-size: 18px" class="tsrc0"></text>
<text x="505" y="45" text-anchor="start" id="cur_val1" style="font-size: 18px" class="tsrc1"></text>
<text x="505" y="65" text-anchor="start" id="cur_val2" style="font-size: 18px" class="tsrc2"></text>
<text x="505" y="85" text-anchor="start" id="cur_val3" style="font-size: 18px" class="tsrc3"></text>
<text x="505" y="105" text-anchor="start" id="cur_val4" style="font-size: 18px" class="tsrc4"></text>
<text x="505" y="125" text-anchor="start" id="cur_val5" style="font-size: 18px" class="tsrc5"></text>
<text x="505" y="145" text-anchor="start" id="cur_val6" style="font-size: 18px" class="tsrc6"></text>
<text x="505" y="165" text-anchor="start" id="cur_val7" style="font-size: 18px" class="tsrc7"></text>
<text x="505" y="185" text-anchor="start" id="cur_val8" style="font-size: 18px" class="tsrc8"></text>

<g transform="translate(55,20)" id="shift">
<text x="5" y="5" text-anchor="start" id="msg" style="font-size: 18px"></text>

<svg class="axis">
    <polyline points="0,150 500,150"/>
    <polyline points="250,150 250,146"/>
    <polyline points="0,0 0,150"/>
</svg>

<svg class="liner">
    <polyline points="0,75 500,75"/>
</svg>
<text x="-5" y="75" text-anchor="end" id="valueMid" style="font-size: 18px">0.5</text>
<text x="250" y="170" text-anchor="middle" id="timeMid" style="font-size: 18px">10s</text>
<text x="-5" y="150" text-anchor="end" id="zeroax" style="font-size: 18px">0</text>


<g transform="translate(0,100) scale(1,-1)" id="trel"/>
</g>
</svg>